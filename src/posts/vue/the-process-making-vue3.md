---
title: "Vue3 设计背后的思考"
date: "2020-08-09"
tags: ["vue"]
origin: "https://increment.com/frontend/making-vue-3/"
---

在过去的一年中，Vue 团队一直在为 Vue.js 的下一个大版本工作。我们希望能在2020年的年中发布（本文写作的时候开发工作正在持续进行中）。Vue 新版本的想法成形于2018年末，彼时 Vue 2 的代码库已经两岁半了。相比于普通软件的生命周期，这似乎并不算太长的时间，但在前端领域，这段时间内已经发生了翻天覆地的变化。

有两个关键的考虑促使我们开发（并重写）Vue 的新的大版本：第一，Javascript 语言新的特性在主流浏览器中得到了普遍的支持；第二，随着时间推移暴露出来的当前代码库设计和架构问题。

### 为什么重写

#### 利用新的语言特性

随着 ES2015 的标准化，Javascript 语言——更正式地说法是 ECMAScript，简称 ES——得到了重要的改善，并且主流浏览器终于开始对这些新增的特性提供了好的支持。其中展现的一些特性我们认为是极大提高 Vue 能力的契机。

最值得一提的特性是 Proxy，它赋予了框架拦截对象操作的能力。Vue 中的一个核心功能是监听用户定义的状态，然后响应式地更新 DOM。 VUe 2 是通过将对象的属性替换成 getter 和 setter 来实现这种响应式。转换到 Proxy 后， Vue 目前存在的一些限制就被解决了，比如，无法监测到新属性的增加。另外，性能也因此更好了。

不过，Proxy 是原生的语言特性，所以没办法完全通过 polyfill 的方式去支持老的浏览器。为了使用这个特性，我们必须调整框架的浏览器支持范围——这是一个巨大的改变，所以只能通过大的新版版来发布。

#### 解决架构问题

在维护 Vue 2 的过程中，我们累积了很多问题，并且因为目前的架构限制很难被解决。举个例子，当前的模板编译器实现导致很难支持良好的 source-map 功能。另外，虽然 Vue 2 在技术上可以实现面向非 DOM 平台的高阶渲染器，但需要 folk 代码库并且复制很多代码来实现。在当前代码库中解决这些问题需要巨大且有风险的重构，几乎等于重写。

同时，因为隐式地耦合了很多内部模块和放哪儿都不合适的孤岛代码，我们因此累积了很多技术债。这使得单独去理解代码中的一部分变得很困难，并且我们发现很多贡献者不敢轻易对代码做改动。重写提供了一次机会，让我们带着这些问题重新思考代码的组织。

### 最初的原型阶段

我们在2018年末开始 Vue 3 的原型工作，最初目标是为了验证上面这些问题的解决方案。在这个阶段，我们主要专注于为以后的开发工作构建一个坚实的基础。

#### 转换到 Typerscript










